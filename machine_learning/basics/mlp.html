<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162942761-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-162942761-1');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Multi-layer perceptron (MLP) from scratch" />
<meta property="og:description" content="MLP API import numpy as np import sys class NeuralNetMLP(object): &#34;&#34;&#34; Feedforward neural network / Multi-layer perceptron classifier. Parameters ------------ n_hidden : int (default: 30) Number of hidden units. l2 : float (default: 0.) Lambda value for L2-regularization. No regularization if l2=0. (default) epochs : int (default: 100) Number of passes over the training set. eta : float (default: 0.001) Learning rate. shuffle : bool (default: True) Shuffles training data every epoch if True to prevent circles." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://othrif.github.io/machine_learning/basics/mlp.html" /><meta property="article:section" content="machine_learning" />
<meta property="article:published_time" content="2020-04-12T14:41:32+02:00" />
<meta property="article:modified_time" content="2020-04-12T14:41:32+02:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Multi-layer perceptron (MLP) from scratch"/>
<meta name="twitter:description" content="MLP API import numpy as np import sys class NeuralNetMLP(object): &#34;&#34;&#34; Feedforward neural network / Multi-layer perceptron classifier. Parameters ------------ n_hidden : int (default: 30) Number of hidden units. l2 : float (default: 0.) Lambda value for L2-regularization. No regularization if l2=0. (default) epochs : int (default: 100) Number of passes over the training set. eta : float (default: 0.001) Learning rate. shuffle : bool (default: True) Shuffles training data every epoch if True to prevent circles."/>
<meta name="generator" content="Hugo 0.85.0" />

    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Multi-layer perceptron (MLP) from scratch",
  "url": "https:\/\/othrif.github.io\/machine_learning\/basics\/mlp.html",
  "wordCount": "1901",
  "datePublished": "2020-04-12T14:41:32\u002b02:00",
  "dateModified": "2020-04-12T14:41:32\u002b02:00",
  "author": {
    "@type": "Person",
    "name": "Othmane Rifki"
  }
}
</script> 

    <title>Multi-layer perceptron (MLP) from scratch</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://othrif.github.io/css/custom.css" rel="stylesheet">
    <link href="https://othrif.github.io/css/syntax.css" rel="stylesheet"> 
    
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    
    <link href="" rel="alternate" type="application/rss+xml" title="Othmane Rifki All Notes And Articles" />
    
    <link href="https://othrif.github.io/articles/index.xml" rel="alternate" type="application/rss+xml" title="Othmane Rifki Articles" />

    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="https://othrif.github.io">Othmane Rifki</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="navbar-nav">

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            Technical Notes
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://othrif.github.io#python">Python</a>
                            <a class="dropdown-item" href="https://othrif.github.io#machine_learning">Machine Learning</a>
                            <a class="dropdown-item" href="https://othrif.github.io#linux">Linux</a>
                            <a class="dropdown-item" href="https://othrif.github.io#scripting">Scripting</a>
                            <a class="dropdown-item" href="https://othrif.github.io#coding">Coding Practice</a>
                        </div>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            About
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://othrif.github.io/about/othmane_rifki.html">About Othmane</a>
                            <a class="dropdown-item" href="https://github.com/othrif" target="_blank">GitHub</a>
                            <a class="dropdown-item" href="https://www.linkedin.com/in/othrif/" target="_blank">LinkedIn</a>
                            <a class="dropdown-item" href="https://twitter.com/othmanerifki" target="_blank">Twitter</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                 


<article>
  <div class="technical_note">
  <header>
    <h1 class="technical_note_title">Multi-layer perceptron (MLP) from scratch</h1>
    <div class="technical_note_date">
      <time datetime=" 2020-04-12T14:41:32&#43;02:00 "> 12 Apr 2020</time>
    </div>
  </header>
  <div class="content">

  <h3 id="mlp-api">MLP API</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">NeuralNetMLP</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34; Feedforward neural network / Multi-layer perceptron classifier.
</span><span class="s2">
</span><span class="s2">    Parameters
</span><span class="s2">    ------------
</span><span class="s2">    n_hidden : int (default: 30)
</span><span class="s2">        Number of hidden units.
</span><span class="s2">    l2 : float (default: 0.)
</span><span class="s2">        Lambda value for L2-regularization.
</span><span class="s2">        No regularization if l2=0. (default)
</span><span class="s2">    epochs : int (default: 100)
</span><span class="s2">        Number of passes over the training set.
</span><span class="s2">    eta : float (default: 0.001)
</span><span class="s2">        Learning rate.
</span><span class="s2">    shuffle : bool (default: True)
</span><span class="s2">        Shuffles training data every epoch if True to prevent circles.
</span><span class="s2">    minibatch_size : int (default: 1)
</span><span class="s2">        Number of training examples per minibatch.
</span><span class="s2">    seed : int (default: None)
</span><span class="s2">        Random seed for initializing weights and shuffling.
</span><span class="s2">
</span><span class="s2">    Attributes
</span><span class="s2">    -----------
</span><span class="s2">    eval_ : dict
</span><span class="s2">      Dictionary collecting the cost, training accuracy,
</span><span class="s2">      and validation accuracy for each epoch during training.
</span><span class="s2">
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_hidden</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">l2</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                 <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_hidden</span> <span class="o">=</span> <span class="n">n_hidden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">=</span> <span class="n">l2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minibatch_size</span> <span class="o">=</span> <span class="n">minibatch_size</span>

    <span class="k">def</span> <span class="nf">_onehot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Encode labels into one-hot representation
</span><span class="s2">
</span><span class="s2">        Parameters
</span><span class="s2">        ------------
</span><span class="s2">        y : array, shape = [n_examples]
</span><span class="s2">            Target values.
</span><span class="s2">        n_classes : int
</span><span class="s2">            Number of classes
</span><span class="s2">
</span><span class="s2">        Returns
</span><span class="s2">        -----------
</span><span class="s2">        onehot : array, shape = (n_examples, n_labels)
</span><span class="s2">
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">onehot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)):</span>
            <span class="n">onehot</span><span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">onehot</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Compute logistic function (sigmoid)&#34;&#34;&#34;</span>
        <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Compute forward propagation step&#34;&#34;&#34;</span>

        <span class="c1"># step 1: net input of hidden layer</span>
        <span class="c1"># [n_examples, n_features] dot [n_features, n_hidden]</span>
        <span class="c1"># -&gt; [n_examples, n_hidden]</span>
        <span class="n">z_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_h</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_h</span>

        <span class="c1"># step 2: activation of hidden layer</span>
        <span class="n">a_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">(</span><span class="n">z_h</span><span class="p">)</span>

        <span class="c1"># step 3: net input of output layer</span>
        <span class="c1"># [n_examples, n_hidden] dot [n_hidden, n_classlabels]</span>
        <span class="c1"># -&gt; [n_examples, n_classlabels]</span>

        <span class="n">z_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_out</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_out</span>

        <span class="c1"># step 4: activation output layer</span>
        <span class="n">a_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">(</span><span class="n">z_out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span>

    <span class="k">def</span> <span class="nf">_compute_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_enc</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Compute cost function.
</span><span class="s2">
</span><span class="s2">        Parameters
</span><span class="s2">        ----------
</span><span class="s2">        y_enc : array, shape = (n_examples, n_labels)
</span><span class="s2">            one-hot encoded class labels.
</span><span class="s2">        output : array, shape = [n_examples, n_output_units]
</span><span class="s2">            Activation of the output layer (forward propagation)
</span><span class="s2">
</span><span class="s2">        Returns
</span><span class="s2">        ---------
</span><span class="s2">        cost : float
</span><span class="s2">            Regularized cost
</span><span class="s2">
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">L2_term</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">*</span>
                   <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_h</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_out</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)))</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_enc</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">y_enc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">term1</span> <span class="o">-</span> <span class="n">term2</span><span class="p">)</span> <span class="o">+</span> <span class="n">L2_term</span>
        
        <span class="c1"># If you are applying this cost function to other</span>
        <span class="c1"># datasets where activation</span>
        <span class="c1"># values maybe become more extreme (closer to zero or 1)</span>
        <span class="c1"># you may encounter &#34;ZeroDivisionError&#34;s due to numerical</span>
        <span class="c1"># instabilities in Python &amp; NumPy for the current implementation.</span>
        <span class="c1"># I.e., the code tries to evaluate log(0), which is undefined.</span>
        <span class="c1"># To address this issue, you could add a small constant to the</span>
        <span class="c1"># activation values that are passed to the log function.</span>
        <span class="c1">#</span>
        <span class="c1"># For example:</span>
        <span class="c1">#</span>
        <span class="c1"># term1 = -y_enc * (np.log(output + 1e-5))</span>
        <span class="c1"># term2 = (1. - y_enc) * np.log(1. - output + 1e-5)</span>
        
        <span class="k">return</span> <span class="n">cost</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Predict class labels
</span><span class="s2">
</span><span class="s2">        Parameters
</span><span class="s2">        -----------
</span><span class="s2">        X : array, shape = [n_examples, n_features]
</span><span class="s2">            Input layer with original features.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">        ----------
</span><span class="s2">        y_pred : array, shape = [n_examples]
</span><span class="s2">            Predicted class labels.
</span><span class="s2">
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_pred</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34; Learn weights from training data.
</span><span class="s2">
</span><span class="s2">        Parameters
</span><span class="s2">        -----------
</span><span class="s2">        X_train : array, shape = [n_examples, n_features]
</span><span class="s2">            Input layer with original features.
</span><span class="s2">        y_train : array, shape = [n_examples]
</span><span class="s2">            Target class labels.
</span><span class="s2">        X_valid : array, shape = [n_examples, n_features]
</span><span class="s2">            Sample features for validation during training
</span><span class="s2">        y_valid : array, shape = [n_examples]
</span><span class="s2">            Sample labels for validation during training
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">        ----------
</span><span class="s2">        self
</span><span class="s2">
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">n_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of class labels</span>
        <span class="n">n_features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">########################</span>
        <span class="c1"># Weight initialization</span>
        <span class="c1">########################</span>

        <span class="c1"># weights for input -&gt; hidden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hidden</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                      <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hidden</span><span class="p">))</span>

        <span class="c1"># weights for hidden -&gt; output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_hidden</span><span class="p">,</span> <span class="n">n_output</span><span class="p">))</span>

        <span class="n">epoch_strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">))</span>  <span class="c1"># for progress formatting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;valid_acc&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="n">y_train_enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onehot</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">n_output</span><span class="p">)</span>

        <span class="c1"># iterate over training epochs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>

            <span class="c1"># iterate over minibatches</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">start_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">minibatch_size</span> <span class="o">+</span>
                                   <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minibatch_size</span><span class="p">):</span>
                <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">minibatch_size</span><span class="p">]</span>

                <span class="c1"># forward propagation</span>
                <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>

                <span class="c1">##################</span>
                <span class="c1"># Backpropagation</span>
                <span class="c1">##################</span>

                <span class="c1"># [n_examples, n_classlabels]</span>
                <span class="n">delta_out</span> <span class="o">=</span> <span class="n">a_out</span> <span class="o">-</span> <span class="n">y_train_enc</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span>

                <span class="c1"># [n_examples, n_hidden]</span>
                <span class="n">sigmoid_derivative_h</span> <span class="o">=</span> <span class="n">a_h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">a_h</span><span class="p">)</span>

                <span class="c1"># [n_examples, n_classlabels] dot [n_classlabels, n_hidden]</span>
                <span class="c1"># -&gt; [n_examples, n_hidden]</span>
                <span class="n">delta_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_out</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span>
                           <span class="n">sigmoid_derivative_h</span><span class="p">)</span>

                <span class="c1"># [n_features, n_examples] dot [n_examples, n_hidden]</span>
                <span class="c1"># -&gt; [n_features, n_hidden]</span>
                <span class="n">grad_w_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">delta_h</span><span class="p">)</span>
                <span class="n">grad_b_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta_h</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># [n_hidden, n_examples] dot [n_examples, n_classlabels]</span>
                <span class="c1"># -&gt; [n_hidden, n_classlabels]</span>
                <span class="n">grad_w_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_h</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">delta_out</span><span class="p">)</span>
                <span class="n">grad_b_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Regularization and weight updates</span>
                <span class="n">delta_w_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_w_h</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">w_h</span><span class="p">)</span>
                <span class="n">delta_b_h</span> <span class="o">=</span> <span class="n">grad_b_h</span> <span class="c1"># bias is not regularized</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_h</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">delta_w_h</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_h</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">delta_b_h</span>

                <span class="n">delta_w_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_w_out</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">w_out</span><span class="p">)</span>
                <span class="n">delta_b_out</span> <span class="o">=</span> <span class="n">grad_b_out</span>  <span class="c1"># bias is not regularized</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_out</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">delta_w_out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_out</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">delta_b_out</span>

            <span class="c1">#############</span>
            <span class="c1"># Evaluation</span>
            <span class="c1">#############</span>

            <span class="c1"># Evaluation after each epoch during training</span>
            <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            
            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cost</span><span class="p">(</span><span class="n">y_enc</span><span class="o">=</span><span class="n">y_train_enc</span><span class="p">,</span>
                                      <span class="n">output</span><span class="o">=</span><span class="n">a_out</span><span class="p">)</span>

            <span class="n">y_train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>

            <span class="n">train_acc</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="n">y_train_pred</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">/</span>
                         <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">valid_acc</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_valid</span> <span class="o">==</span> <span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">/</span>
                         <span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%0*d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> | Cost: </span><span class="si">%.2f</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;| Train/Valid Acc.: </span><span class="si">%.2f%%</span><span class="s1">/</span><span class="si">%.2f%%</span><span class="s1"> &#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">epoch_strlen</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span>
                              <span class="n">train_acc</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">valid_acc</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_acc</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div><h3 id="get-data">Get data</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="n">writemode</span> <span class="o">=</span> <span class="s1">&#39;wb&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">writemode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>

<span class="n">zipped_mnist</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ubyte.gz&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zipped_mnist</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">decompressed</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">writemode</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decompressed</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> 
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
 
<span class="k">def</span> <span class="nf">load_mnist</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Load MNIST data from `path`&#34;&#34;&#34;</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> 
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-labels-idx1-ubyte&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
    <span class="n">images_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> 
                               <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-images-idx3-ubyte&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
        
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbpath</span><span class="p">:</span>
        <span class="n">magic</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;II&#39;</span><span class="p">,</span> 
                                 <span class="n">lbpath</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">lbpath</span><span class="p">,</span> 
                             <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">images_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">imgpath</span><span class="p">:</span>
        <span class="n">magic</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&gt;IIII&#34;</span><span class="p">,</span> 
                                               <span class="n">imgpath</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">imgpath</span><span class="p">,</span> 
                             <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="mi">784</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">((</span><span class="n">images</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
 
    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rows: </span><span class="si">%d</span><span class="s1">, columns: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_mnist</span><span class="p">(</span><span class="s1">&#39;/tmp/&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;t10k&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rows: </span><span class="si">%d</span><span class="s1">, columns: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div><pre><code>Rows: 60000, columns: 784
Rows: 10000, columns: 784
</code></pre>
<h3 id="train-mlp">Train MLP</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">75</span>
<span class="n">nn</span> <span class="o">=</span> <span class="n">NeuralNetMLP</span><span class="p">(</span><span class="n">n_hidden</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                  <span class="n">l2</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
                  <span class="n">epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span> 
                  <span class="n">eta</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                  <span class="n">minibatch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                  <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">[:</span><span class="mi">55000</span><span class="p">],</span> 
       <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">[:</span><span class="mi">55000</span><span class="p">],</span>
       <span class="n">X_valid</span><span class="o">=</span><span class="n">X_train</span><span class="p">[</span><span class="mi">55000</span><span class="p">:],</span>
       <span class="n">y_valid</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">55000</span><span class="p">:])</span>
</code></pre></div><pre><code>75/75 | Cost: 9515.78 | Train/Valid Acc.: 97.94%/97.60%  




&lt;__main__.NeuralNetMLP at 0x112ea8850&gt;
</code></pre>
<h3 id="plot-cost-and-accuracy">Plot cost and accuracy</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">epochs</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&#39;images/12_07.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div><p><img src="mlp_9_0.png" alt="png"></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">epochs</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">],</span> 
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">epochs</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">],</span> 
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&#39;images/12_08.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div><p><img src="mlp_10_0.png" alt="png"></p>
<h3 id="determine-test-accuracy-and-plot-some-examples">Determine test accuracy and plot some examples</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_test</span> <span class="o">==</span> <span class="n">y_test_pred</span><span class="p">)</span>
       <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test accuracy: </span><span class="si">%.2f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">acc</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</code></pre></div><pre><code>Test accuracy: 96.93%
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">miscl_img</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">y_test</span> <span class="o">!=</span> <span class="n">y_test_pred</span><span class="p">][:</span><span class="mi">25</span><span class="p">]</span>
<span class="n">correct_lab</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">y_test</span> <span class="o">!=</span> <span class="n">y_test_pred</span><span class="p">][:</span><span class="mi">25</span><span class="p">]</span>
<span class="n">miscl_lab</span> <span class="o">=</span> <span class="n">y_test_pred</span><span class="p">[</span><span class="n">y_test</span> <span class="o">!=</span> <span class="n">y_test_pred</span><span class="p">][:</span><span class="mi">25</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">miscl_img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">) t: </span><span class="si">%d</span><span class="s1"> p: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">correct_lab</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">miscl_lab</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1">#plt.savefig(&#39;images/12_09.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div><p><img src="mlp_13_0.png" alt="png"></p>
<h3 id="break-mlp-api-for-learning">Break MLP API for learning</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_onehot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">):</span>
    <span class="n">onehot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)):</span>
        <span class="n">onehot</span><span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">return</span> <span class="n">onehot</span><span class="o">.</span><span class="n">T</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Compute logistic function (sigmoid)&#34;&#34;&#34;</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)))</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_forward</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Compute forward propagation step&#34;&#34;&#34;</span>
    
    <span class="c1"># step 1: net input of hidden layer</span>
    <span class="c1"># [n_examples, n_features] dot [n_features, n_hidden]</span>
    <span class="c1"># -&gt; [n_examples, n_hidden]</span>
    <span class="n">z_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w_h</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_h</span>
    
    <span class="c1"># step 2: activation of hidden layer</span>
    <span class="n">a_h</span> <span class="o">=</span> <span class="n">_sigmoid</span><span class="p">(</span><span class="n">z_h</span><span class="p">)</span>
    
    <span class="c1"># step 3: net input of output layer</span>
    <span class="c1"># [n_examples, n_hidden] dot [n_hidden, n_classlabels]</span>
    <span class="c1"># -&gt; [n_examples, n_classlabels]</span>
    <span class="n">z_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_out</span>
    
    <span class="c1"># step 4: activation output layer</span>
    <span class="n">a_out</span> <span class="o">=</span> <span class="n">_sigmoid</span><span class="p">(</span><span class="n">z_out</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_compute_cost</span><span class="p">(</span><span class="n">y_enc</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Compute cost function.
</span><span class="s2">
</span><span class="s2">        Parameters
</span><span class="s2">        ----------
</span><span class="s2">        y_enc : array, shape = (n_examples, n_labels)
</span><span class="s2">            one-hot encoded class labels.
</span><span class="s2">        output : array, shape = [n_examples, n_output_units]
</span><span class="s2">            Activation of the output layer (forward propagation)
</span><span class="s2">
</span><span class="s2">        Returns
</span><span class="s2">        ---------
</span><span class="s2">        cost : float
</span><span class="s2">            Regularized cost
</span><span class="s2">
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">L2_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">l2</span> <span class="o">*</span>
                   <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_h</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_out</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)))</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_enc</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">y_enc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">term1</span> <span class="o">-</span> <span class="n">term2</span><span class="p">)</span> <span class="o">+</span> <span class="n">L2_term</span>
        
        
        <span class="k">return</span> <span class="n">cost</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Predict class labels
</span><span class="s2">
</span><span class="s2">        Parameters
</span><span class="s2">        -----------
</span><span class="s2">        X : array, shape = [n_examples, n_features]
</span><span class="s2">            Input layer with original features.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">        ----------
</span><span class="s2">        y_pred : array, shape = [n_examples]
</span><span class="s2">            Predicted class labels.
</span><span class="s2">
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span> <span class="o">=</span> <span class="n">_forward</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_pred</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    
    <span class="c1"># Parameters</span>
    <span class="n">n_hidden</span> <span class="o">=</span> <span class="mi">30</span>
<span class="c1">#    epochs = 10</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">minibatch_size</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">eta</span><span class="o">=</span><span class="mf">0.0005</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X train shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;y train shape: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X test shape: </span><span class="si">{</span><span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;y test shape: </span><span class="si">{</span><span class="n">y_valid</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">n_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of class labels</span>
    <span class="n">n_features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Number of outputs: </span><span class="si">{</span><span class="n">n_output</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of outputs: </span><span class="si">{</span><span class="n">n_features</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Weight initialization</span>

    <span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
    
    <span class="c1"># weights for input -&gt; hidden</span>
    <span class="n">b_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">)</span>
    <span class="n">w_h</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bias input -&gt; hidden: </span><span class="si">{</span><span class="n">b_h</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weights input -&gt; hidden: </span><span class="si">{</span><span class="n">w_h</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># weights for hidden -&gt; output</span>
    <span class="n">b_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_output</span><span class="p">)</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">,</span> <span class="n">n_output</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bias hidden -&gt; output: </span><span class="si">{</span><span class="n">b_out</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weights hidden -&gt; output: </span><span class="si">{</span><span class="n">w_out</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    
    <span class="n">epoch_strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>  <span class="c1"># for progress formatting</span>
    <span class="n">eval_</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;valid_acc&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    
    <span class="n">y_train_enc</span> <span class="o">=</span> <span class="n">_onehot</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">n_output</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Y train: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Y train encoding: </span><span class="si">{</span><span class="n">y_train_enc</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># iterate over training epochs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        
        <span class="c1"># iterate over minibatches</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">start_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">minibatch_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="p">)):</span>
            
            <span class="c1">#print(f&#39;start_idx={start_idx+minibatch_size}/{indices.shape[0]} -&gt; {j+1}/{indices.shape[0]/minibatch_size}&#39;)</span>
            
            <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">minibatch_size</span><span class="p">]</span>
            
            <span class="c1">##################</span>
            <span class="c1"># forward propagation</span>
            <span class="c1">##################</span>
            
            <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span> <span class="o">=</span> <span class="n">_forward</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">)</span>
            
            <span class="c1">##################</span>
            <span class="c1"># Backpropagation</span>
            <span class="c1">##################</span>
            
            <span class="c1"># [n_examples, n_classlabels]</span>
            <span class="n">delta_out</span> <span class="o">=</span> <span class="n">a_out</span> <span class="o">-</span> <span class="n">y_train_enc</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span>
            
            <span class="c1"># [n_examples, n_hidden]</span>
            <span class="n">sigmoid_derivative_h</span> <span class="o">=</span> <span class="n">a_h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">a_h</span><span class="p">)</span>
            
            <span class="c1"># [n_examples, n_classlabels] dot [n_classlabels, n_hidden]</span>
            <span class="c1"># -&gt; [n_examples, n_hidden]</span>
            <span class="n">delta_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta_out</span><span class="p">,</span> <span class="n">w_out</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigmoid_derivative_h</span><span class="p">)</span>
            
            <span class="c1"># [n_features, n_examples] dot [n_examples, n_hidden]</span>
            <span class="c1"># -&gt; [n_features, n_hidden]</span>
            <span class="n">grad_w_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">delta_h</span><span class="p">)</span>
            <span class="n">grad_b_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta_h</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># [n_hidden, n_examples] dot [n_examples, n_classlabels]</span>
            <span class="c1"># -&gt; [n_hidden, n_classlabels]</span>
            <span class="n">grad_w_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a_h</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">delta_out</span><span class="p">)</span>
            <span class="n">grad_b_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">delta_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Regularization and weight updates</span>
            <span class="n">delta_w_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_w_h</span> <span class="o">+</span> <span class="n">l2</span><span class="o">*</span><span class="n">w_h</span><span class="p">)</span>
            <span class="n">delta_b_h</span> <span class="o">=</span> <span class="n">grad_b_h</span> <span class="c1"># bias is not regularized</span>
            <span class="n">w_h</span> <span class="o">-=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">delta_w_h</span>
            <span class="n">b_h</span> <span class="o">-=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">delta_b_h</span>
            
            <span class="n">delta_w_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad_w_out</span> <span class="o">+</span> <span class="n">l2</span><span class="o">*</span><span class="n">w_out</span><span class="p">)</span>
            <span class="n">delta_b_out</span> <span class="o">=</span> <span class="n">grad_b_out</span>  <span class="c1"># bias is not regularized</span>
            <span class="n">w_out</span> <span class="o">-=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">delta_w_out</span>
            <span class="n">b_out</span> <span class="o">-=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">delta_b_out</span>
            
            
        <span class="c1">#############</span>
        <span class="c1"># Evaluation</span>
        <span class="c1">#############</span>
        <span class="c1"># Evaluation after each epoch during training</span>
        <span class="n">z_h</span><span class="p">,</span> <span class="n">a_h</span><span class="p">,</span> <span class="n">z_out</span><span class="p">,</span> <span class="n">a_out</span> <span class="o">=</span> <span class="n">_forward</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">)</span>
        
        <span class="n">cost</span> <span class="o">=</span> <span class="n">_compute_cost</span><span class="p">(</span><span class="n">y_enc</span><span class="o">=</span><span class="n">y_train_enc</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">a_out</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">l2</span><span class="p">,</span> <span class="n">w_h</span><span class="o">=</span><span class="n">w_h</span><span class="p">,</span> <span class="n">w_out</span><span class="o">=</span><span class="n">w_out</span><span class="p">)</span>
        <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">)</span>
        <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">w_h</span><span class="p">,</span> <span class="n">b_h</span><span class="p">,</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">b_out</span><span class="p">)</span>
        <span class="n">train_acc</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_train</span> <span class="o">==</span> <span class="n">y_train_pred</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">/</span>
                        <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">valid_acc</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_valid</span> <span class="o">==</span> <span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">/</span>
                        <span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">%0*d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> | Cost: </span><span class="si">%.2f</span><span class="s1"> &#39;</span>
                            <span class="s1">&#39;| Train/Valid Acc.: </span><span class="si">%.2f%%</span><span class="s1">/</span><span class="si">%.2f%%</span><span class="s1"> &#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">epoch_strlen</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span>
                            <span class="n">train_acc</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">valid_acc</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
        <span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span>
        <span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_acc</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">eval_</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">eval_</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">[:</span><span class="mi">55000</span><span class="p">],</span> 
       <span class="n">y_train</span><span class="o">=</span><span class="n">y_train</span><span class="p">[:</span><span class="mi">55000</span><span class="p">],</span>
       <span class="n">X_valid</span><span class="o">=</span><span class="n">X_train</span><span class="p">[</span><span class="mi">55000</span><span class="p">:],</span>
       <span class="n">y_valid</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">55000</span><span class="p">:],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
</code></pre></div><pre><code>X train shape: (55000, 784)
y train shape: (55000,)
X test shape: (5000, 784)
y test shape: (5000,)

Number of outputs: 10
Number of outputs: 784

Bias input -&gt; hidden: (30,)
Weights input -&gt; hidden: (784, 30)

Bias hidden -&gt; output: (10,)
Weights hidden -&gt; output: (30, 10)

Y train: (55000,)

Y train encoding: (55000, 10)


10/10 | Cost: 31420.29 | Train/Valid Acc.: 91.69%/93.38%  
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cost&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&#39;images/12_07.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div><p><img src="mlp_22_0.png" alt="png"></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">],</span> 
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">eval_</span><span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">],</span> 
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="c1">#plt.savefig(&#39;images/12_08.png&#39;, dpi=300)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div><p><img src="mlp_23_0.png" alt="png"></p>

</div>
  <aside>
      <div class="bug_reporting">
          <h4>Find an error?</h4>
          <p>All material is saved on GitHub. Please <a href='https://github.com/othrif/notes_othmanerifki/issues/new'>submit a suggested change</a> and include the note's URL in the issue.</p>
      </div>
      </aside>

    </div>
</article>




            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">Copyright &copy; Othmane Rifki, <time datetime="2020">2020</time>. All 153 notes and articles are available on <a href="https://github.com/othrif/">GitHub</a>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>